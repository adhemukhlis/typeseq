var l={string:"s",number:"n",boolean:"b",date:"d",null:"x"},y={s:e=>{let t=e.trim();return t.startsWith('"')&&t.endsWith('"')?JSON.parse(t):t},n:e=>{let t=e.trim();if(t==="")return null;let r=Number(t);return Number.isFinite(r)?r:null},b:e=>{let t=e.trim().toLowerCase();if(t==="true")return  true;if(t==="false")return  false;throw new Error(`Invalid boolean: ${e}`)},d:e=>{let t=e.trim(),r=t.startsWith('"')&&t.endsWith('"')?JSON.parse(t):t,n=new Date(r);if(Number.isNaN(n.getTime()))throw new Error(`Invalid date: ${e}`);return n},x:e=>null};function m(e){if(e===null||typeof e!="object"||Array.isArray(e))return  false;let t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}function p(e,t){let r=[],n="",o=false,i=false;for(let a=0;a<e.length;a++){let s=e[a];if(i){n+=s,i=false;continue}if(s==="\\"){n+=s,i=true;continue}if(s==='"'){n+=s,o=!o;continue}if(!o&&s===t){r.push(n),n="";continue}n+=s;}return r.push(n),r}function f(e){if(e===null)return l.null;if(e instanceof Date)return l.date;let t=typeof e;if(t==="string")return l.string;if(t==="number")return l.number;if(t==="boolean")return l.boolean;throw new Error(`Unsupported type: ${String(t)}`)}function g(e,t,r){if(e==="x")return "";if(e==="s")return JSON.stringify(r);if(e==="n"){let o=r;return Number.isFinite(o)?String(o):""}if(e==="b")return r?"true":"false";if(e==="d"){if(!(r instanceof Date))throw new Error(`Expected Date for "${t}"`);return JSON.stringify(r.toISOString())}let n=e;throw new Error(`Unknown alias: ${n}`)}function h(e){if(!m(e))throw new Error("encode expects a flat plain object");let t=Object.keys(e).sort(),r=[];for(let n of t){let o=e[n];if(o===void 0)continue;let i=f(o),a=g(i,n,o);r.push(`${n};${i};${a}`);}return r.join("|")}function w(e){if(typeof e!="string")throw new Error("decode expects string");let t={},r=p(e,"|").filter(n=>n.length>0);for(let n of r){let o=p(n,";");if(o.length!==3)throw new Error(`Invalid row (expected 3 parts): ${n}`);let[i,a,s]=o,u=i.trim(),d=a.trim();if(!u)throw new Error(`Empty key in row: ${n}`);let c=y[d];if(!c)throw new Error(`Unknown type alias "${a.trim()}" in row: ${n}`);t[u]=c(s);}return t}function b(e){return typeof e=="string"?{type:e,optional:false}:{type:e.type,optional:!!e.optional}}function S(e,t){let r=w(e),n={};for(let o of Object.keys(t)){let{type:i,optional:a}=b(t[o]);if(!(o in r)){if(a){n[o]=void 0;continue}throw new Error(`Missing required key "${o}"`)}let s=r[o],u=f(s);if(u!==i)throw new Error(`Type mismatch for "${o}": expected ${i} but got ${u}`);n[o]=s;}return n}export{w as decode,S as decodeWithSchema,h as encode};